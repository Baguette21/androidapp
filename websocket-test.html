<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECTrivia WebSocket Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { background: #16213e; border-radius: 10px; padding: 20px; flex: 1; min-width: 300px; }
        .panel h2 { color: #00d4ff; margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; }
        .status.connected { background: #0f5132; color: #75b798; }
        .status.disconnected { background: #842029; color: #f5c2c7; }
        .status.connecting { background: #664d03; color: #ffda6a; }
        input, button, select { padding: 10px; border-radius: 5px; border: none; margin: 5px 0; }
        input, select { background: #0f3460; color: #fff; width: 100%; }
        button { background: #00d4ff; color: #000; cursor: pointer; font-weight: bold; }
        button:hover { background: #00a8cc; }
        button:disabled { background: #555; cursor: not-allowed; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-success { background: #198754; color: #fff; }
        .log-area { background: #0a0a1a; border-radius: 5px; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { padding: 5px; border-bottom: 1px solid #222; }
        .log-entry.event { color: #00d4ff; }
        .log-entry.error { color: #f55; }
        .log-entry.sent { color: #0f0; }
        .log-entry.info { color: #ff0; }
        .form-group { margin-bottom: 10px; }
        label { display: block; color: #888; font-size: 12px; margin-bottom: 3px; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { flex: 1; }
        .player-list { list-style: none; padding: 0; margin: 0; }
        .player-list li { padding: 8px; background: #0f3460; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; }
        .player-list .host { color: #ffc107; }
        .score { font-weight: bold; color: #00d4ff; }
    </style>
</head>
<body>
    <h1>ECTrivia WebSocket Test Client</h1>
    <p class="subtitle">Test real-time game events via STOMP over WebSocket</p>

    <div class="container">
        <!-- Connection Panel -->
        <div class="panel">
            <h2>Connection</h2>
            <div id="connectionStatus" class="status disconnected">Disconnected</div>
            
            <div class="form-group">
                <label>WebSocket URL</label>
                <input type="text" id="wsUrl" value="http://localhost:8081/ws">
            </div>
            
            <div class="btn-group">
                <button id="btnConnect" onclick="connect()">Connect</button>
                <button id="btnDisconnect" onclick="disconnect()" disabled class="btn-danger">Disconnect</button>
            </div>

            <h2 style="margin-top: 20px;">Room Subscription</h2>
            <div class="form-group">
                <label>Room Code</label>
                <input type="text" id="roomCode" placeholder="e.g., ABC123" style="text-transform: uppercase;">
            </div>
            <div class="btn-group">
                <button id="btnSubscribe" onclick="subscribeToRoom()" disabled>Subscribe</button>
                <button id="btnUnsubscribe" onclick="unsubscribeFromRoom()" disabled class="btn-danger">Unsubscribe</button>
            </div>
        </div>

        <!-- Game Actions Panel -->
        <div class="panel">
            <h2>Game Actions (REST API)</h2>
            
            <div class="form-group">
                <label>Your Nickname</label>
                <input type="text" id="nickname" placeholder="Enter nickname">
            </div>
            
            <div class="btn-group">
                <button onclick="createRoom()" class="btn-success">Create Room</button>
                <button onclick="joinRoom()">Join Room</button>
            </div>
            
            <div class="btn-group" style="margin-top: 10px;">
                <button onclick="startGame()" class="btn-success">Start Game</button>
                <button onclick="getLeaderboard()">Get Leaderboard</button>
            </div>

            <h2 style="margin-top: 20px;">Submit Answer</h2>
            <div class="form-group">
                <label>Question ID</label>
                <input type="number" id="questionId" placeholder="Question ID">
            </div>
            <div class="form-group">
                <label>Answer Index (0-3)</label>
                <select id="answerIndex">
                    <option value="0">0 - First Answer</option>
                    <option value="1">1 - Second Answer</option>
                    <option value="2">2 - Third Answer</option>
                    <option value="3">3 - Fourth Answer</option>
                </select>
            </div>
            <button onclick="submitAnswer()" style="width: 100%;">Submit Answer</button>
        </div>

        <!-- Players Panel -->
        <div class="panel">
            <h2>Players in Room</h2>
            <ul id="playerList" class="player-list">
                <li style="color: #666;">No players yet</li>
            </ul>
            
            <h2 style="margin-top: 20px;">Current Question</h2>
            <div id="currentQuestion" style="background: #0a0a1a; padding: 15px; border-radius: 5px;">
                <p style="color: #666;">Waiting for game to start...</p>
            </div>
        </div>
    </div>

    <!-- Event Log -->
    <div class="panel" style="margin-top: 20px; flex-basis: 100%;">
        <h2>Event Log <button onclick="clearLog()" style="float: right; padding: 5px 10px; font-size: 12px;">Clear</button></h2>
        <div id="eventLog" class="log-area"></div>
    </div>

    <script>
        let stompClient = null;
        let subscriptions = {};
        let playerId = null;
        let currentRoomCode = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color:#666">[${time}]</span> ${message}`;
            logArea.insertBefore(entry, logArea.firstChild);
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }

        function setConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            el.className = `status ${status}`;
            el.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            document.getElementById('btnConnect').disabled = status === 'connected';
            document.getElementById('btnDisconnect').disabled = status !== 'connected';
            document.getElementById('btnSubscribe').disabled = status !== 'connected';
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;
            setConnectionStatus('connecting');
            log(`Connecting to ${url}...`, 'info');

            const socket = new SockJS(url);
            stompClient = Stomp.over(socket);
            
            // Disable debug logging
            stompClient.debug = null;

            stompClient.connect({}, 
                function(frame) {
                    setConnectionStatus('connected');
                    log('Connected to WebSocket server!', 'event');
                    log(`Session: ${frame.headers['user-name'] || 'anonymous'}`, 'info');
                },
                function(error) {
                    setConnectionStatus('disconnected');
                    log(`Connection error: ${error}`, 'error');
                }
            );
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect(function() {
                    setConnectionStatus('disconnected');
                    log('Disconnected from WebSocket server', 'info');
                });
            }
        }

        function subscribeToRoom() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (!roomCode) {
                log('Please enter a room code', 'error');
                return;
            }

            currentRoomCode = roomCode;
            log(`Subscribing to room ${roomCode}...`, 'info');

            // Subscribe to game events
            subscriptions.game = stompClient.subscribe(`/topic/room/${roomCode}/game`, function(message) {
                const data = JSON.parse(message.body);
                log(`GAME EVENT: ${JSON.stringify(data, null, 2)}`, 'event');
                handleGameEvent(data);
            });
            log(`Subscribed to /topic/room/${roomCode}/game`, 'sent');

            // Subscribe to player events
            subscriptions.players = stompClient.subscribe(`/topic/room/${roomCode}/players`, function(message) {
                const data = JSON.parse(message.body);
                log(`PLAYER EVENT: ${JSON.stringify(data, null, 2)}`, 'event');
                handlePlayerEvent(data);
            });
            log(`Subscribed to /topic/room/${roomCode}/players`, 'sent');

            // Subscribe to leaderboard updates
            subscriptions.leaderboard = stompClient.subscribe(`/topic/room/${roomCode}/leaderboard`, function(message) {
                const data = JSON.parse(message.body);
                log(`LEADERBOARD UPDATE: ${JSON.stringify(data, null, 2)}`, 'event');
            });
            log(`Subscribed to /topic/room/${roomCode}/leaderboard`, 'sent');

            document.getElementById('btnSubscribe').disabled = true;
            document.getElementById('btnUnsubscribe').disabled = false;
        }

        function unsubscribeFromRoom() {
            Object.values(subscriptions).forEach(sub => sub.unsubscribe());
            subscriptions = {};
            currentRoomCode = null;
            log('Unsubscribed from all room topics', 'info');
            
            document.getElementById('btnSubscribe').disabled = false;
            document.getElementById('btnUnsubscribe').disabled = true;
        }

        function handleGameEvent(data) {
            const eventType = data.eventType || data.payload?.eventType;
            
            if (eventType === 'QUESTION_START' || data.question) {
                const q = data.question || data.payload?.question;
                if (q) {
                    document.getElementById('questionId').value = q.id;
                    let html = `<p style="color:#00d4ff; font-size: 18px; margin-bottom: 10px;">${q.questionText}</p>`;
                    if (q.answers) {
                        q.answers.forEach((a, i) => {
                            html += `<div style="padding: 8px; margin: 5px 0; background: #16213e; border-radius: 5px;">${i}: ${a.answerText}</div>`;
                        });
                    }
                    html += `<p style="color: #ff0; margin-top: 10px;">Timer: ${data.timerSeconds || 15}s</p>`;
                    document.getElementById('currentQuestion').innerHTML = html;
                }
            }
            
            if (eventType === 'QUESTION_END') {
                document.getElementById('currentQuestion').innerHTML = `
                    <p style="color: #0f0;">Question ended! Correct answer: ${data.correctAnswerIndex}</p>
                `;
            }
            
            if (eventType === 'GAME_FINISHED') {
                document.getElementById('currentQuestion').innerHTML = `
                    <p style="color: #ffc107; font-size: 24px;">Game Over!</p>
                `;
            }
        }

        function handlePlayerEvent(data) {
            // Refresh player list
            getPlayers();
        }

        // REST API Functions
        async function apiCall(method, endpoint, body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(`http://localhost:8081${endpoint}`, options);
                const data = await response.json();
                return data;
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                return null;
            }
        }

        async function createRoom() {
            log('Creating new room...', 'sent');
            const data = await apiCall('POST', '/api/rooms', {
                isThemeBased: false,
                questionTimerSeconds: 15
            });
            if (data) {
                document.getElementById('roomCode').value = data.roomCode;
                log(`Room created: ${data.roomCode}`, 'event');
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            const nickname = document.getElementById('nickname').value;
            
            if (!roomCode || !nickname) {
                log('Please enter room code and nickname', 'error');
                return;
            }

            log(`Joining room ${roomCode} as ${nickname}...`, 'sent');
            const data = await apiCall('POST', `/api/rooms/${roomCode}/join`, { nickname });
            
            if (data) {
                playerId = data.id;
                log(`Joined! Player ID: ${playerId}, Host: ${data.isHost}`, 'event');
                getPlayers();
            }
        }

        async function startGame() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (!roomCode || !playerId) {
                log('Join a room first', 'error');
                return;
            }

            log('Starting game...', 'sent');
            const data = await apiCall('POST', `/api/rooms/${roomCode}/start?playerId=${playerId}`);
            if (data) {
                log(`Game started! Status: ${data.status}`, 'event');
            }
        }

        async function submitAnswer() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            const questionId = document.getElementById('questionId').value;
            const answerIndex = parseInt(document.getElementById('answerIndex').value);

            if (!roomCode || !playerId || !questionId) {
                log('Missing required fields', 'error');
                return;
            }

            log(`Submitting answer ${answerIndex} for question ${questionId}...`, 'sent');
            const data = await apiCall('POST', `/api/rooms/${roomCode}/answer`, {
                playerId,
                questionId: parseInt(questionId),
                selectedAnswerIndex: answerIndex,
                answerTimeMs: 3000
            });

            if (data) {
                const result = data.isCorrect ? 'CORRECT!' : 'Wrong';
                log(`Answer: ${result} | Points: ${data.pointsEarned} | Total: ${data.newTotalScore} | Streak: ${data.newStreak}`, 'event');
            }
        }

        async function getLeaderboard() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (!roomCode) return;

            const data = await apiCall('GET', `/api/rooms/${roomCode}/leaderboard`);
            if (data) {
                log(`Leaderboard: ${JSON.stringify(data.leaderboard)}`, 'info');
                updatePlayerList(data.leaderboard);
            }
        }

        async function getPlayers() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (!roomCode) return;

            const data = await apiCall('GET', `/api/rooms/${roomCode}`);
            if (data && data.players) {
                updatePlayerList(data.players);
            }
        }

        function updatePlayerList(players) {
            const list = document.getElementById('playerList');
            if (!players || players.length === 0) {
                list.innerHTML = '<li style="color: #666;">No players yet</li>';
                return;
            }

            list.innerHTML = players.map(p => `
                <li>
                    <span class="${p.isHost ? 'host' : ''}">${p.nickname || p.playerNickname} ${p.isHost ? '(Host)' : ''}</span>
                    <span class="score">${p.totalScore || 0} pts</span>
                </li>
            `).join('');
        }

        // Auto-connect on load
        window.onload = function() {
            log('WebSocket Test Client loaded. Click "Connect" to start.', 'info');
        };
    </script>
</body>
</html>
